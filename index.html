<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Stakeé¢¨ Dice Game æ‹¡å¼µç‰ˆ</title>
<style>
  body {
    background: #121212;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-align: center;
    padding: 20px;
  }
  input, button, select {
    font-size: 16px;
    margin: 5px;
    padding: 8px;
  }
  #dice {
    margin: 20px auto;
    width: 100px; height: 100px;
  }
  #history {
    max-height: 150px;
    overflow-y: auto;
    background: #222;
    padding: 10px;
    border-radius: 8px;
    text-align: left;
    margin: 20px auto;
    width: 300px;
    font-size: 14px;
  }
  #loginArea {
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<h1>ğŸ² Stakeé¢¨ Dice Game æ‹¡å¼µç‰ˆ</h1>

<div id="loginArea">
  ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" id="usernameInput" placeholder="åå‰å…¥åŠ›" />
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <div id="welcomeMsg" style="margin-top:10px;"></div>
</div>

<div id="gameArea" style="display:none;">

  <div>
    æ‰€æŒé‡‘: <span id="balance">0</span> å††<br />
    éŠ€è¡Œ: <span id="bank">0</span> å††
  </div>

  <div style="margin-top: 15px;">
    <label>å€ç‡:
      <input type="number" id="multiplier" value="2" step="0.1" min="1" max="100" />
    </label>
    <label>å‹ç‡ (%):
      <input type="number" id="winrate" value="49" step="0.1" min="1" max="99" />
    </label>
  </div>

  <svg id="dice" viewBox="0 0 100 100">
    <rect width="100" height="100" rx="15" ry="15" fill="#444" />
    <!-- ç‚¹ã¯å¾Œã§JSã§æç”» -->
  </svg>

  <div style="margin-top: 10px;">
    <input type="number" id="bet" value="100" min="1" max="10000000" />
    å††ã‚’è³­ã‘ã‚‹ï¼ˆæœ€å¤§ï¼š<span id="maxBet">0</span>å††ï¼‰
    <button onclick="playDice()">ğŸ² ãƒ—ãƒ¬ã‚¤</button>
  </div>

  <div style="margin-top: 20px;">
    <button id="workBtn" onclick="work()">ğŸ’¼ WORK</button><br />
    <small id="cooldownInfo"></small>
  </div>

  <div style="margin-top: 20px;">
    <input type="number" id="amount" value="0" />
    <button onclick="deposit()">éŠ€è¡Œã«é ã‘ã‚‹</button>
    <button onclick="withdraw()">å¼•ãå‡ºã™</button>
  </div>

  <h3>ãƒ—ãƒ¬ã‚¤å±¥æ­´</h3>
  <div id="history"></div>

</div>

<script>
  // Cookieæ“ä½œé–¢æ•°
  function getCookie(name) {
    const value = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return value ? decodeURIComponent(value.pop()) : null;
  }

  function setCookie(name, value, days = 365) {
    const date = new Date();
    date.setTime(date.getTime() + days*24*60*60*1000);
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${date.toUTCString()}; path=/`;
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let currentUser = null;
  let data = {}; // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜
  function loadUserData(username) {
    const raw = getCookie('user_' + username);
    if (raw) return JSON.parse(raw);
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸå€¤
    return {
      balance: 1000,
      bank: 0,
      lastWork: 0,
      history: []
    };
  }

  function saveUserData() {
    if (!currentUser) return;
    setCookie('user_' + currentUser, JSON.stringify(data[currentUser]));
  }

  // UI æ›´æ–°
  function updateDisplay() {
    if (!currentUser) return;

    const userData = data[currentUser];

    document.getElementById('balance').textContent = userData.balance;
    document.getElementById('bank').textContent = userData.bank;

    // æœ€å¤§æ›ã‘é‡‘ã¯æ‰€æŒé‡‘ã¾ã§
    document.getElementById('maxBet').textContent = userData.balance;

    // BETå…¥åŠ›å€¤ã‚’åˆ¶é™å†…ã«
    const betInput = document.getElementById('bet');
    if (parseInt(betInput.value) > userData.balance) betInput.value = userData.balance;

    // å±¥æ­´è¡¨ç¤º
    const historyDiv = document.getElementById('history');
    historyDiv.innerHTML = "";
    if(userData.history.length === 0){
      historyDiv.textContent = "ã¾ã ãƒ—ãƒ¬ã‚¤å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    } else {
      userData.history.slice().reverse().forEach(h => {
        const el = document.createElement('div');
        el.textContent = `${new Date(h.time).toLocaleString()} - è³­ã‘é‡‘: ${h.bet}å†† - ${h.result} - æ®‹é«˜: ${h.balance}å††`;
        historyDiv.appendChild(el);
      });
    }

    updateCooldownInfo();
    drawDice(null); // Reset dice display
  }

  // ãƒ­ã‚°ã‚¤ãƒ³
  function login() {
    const input = document.getElementById('usernameInput');
    let username = input.value.trim();
    if (!username) {
      alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    currentUser = username;
    data[currentUser] = loadUserData(currentUser);

    document.getElementById('welcomeMsg').textContent = `ã‚ˆã†ã“ãã€${currentUser}ã•ã‚“ï¼`;
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('gameArea').style.display = 'block';

    updateDisplay();
  }

  // ãƒ€ã‚¤ã‚¹ã®æç”»ï¼ˆã‚µã‚¤ã‚³ãƒ­ã®ç‚¹ï¼‰
  function drawDice(number) {
    const svg = document.getElementById('dice');
    // ã‚¯ãƒªã‚¢å‰ã®ç‚¹
    while(svg.lastChild && svg.lastChild.tagName === 'circle') {
      svg.removeChild(svg.lastChild);
    }
    if (number == null) return;

    // ç‚¹ã®ä½ç½®ã‚’æ±ºã‚ã‚‹ï¼ˆ100x100ã®æ­£æ–¹å½¢å†…ï¼‰
    const positions = {
      1: [[50,50]],
      2: [[25,25],[75,75]],
      3: [[25,25],[50,50],[75,75]],
      4: [[25,25],[25,75],[75,25],[75,75]],
      5: [[25,25],[25,75],[50,50],[75,25],[75,75]],
      6: [[25,25],[25,50],[25,75],[75,25],[75,50],[75,75]]
    };

    const pts = positions[number] || [];

    pts.forEach(([x,y]) => {
      const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      c.setAttribute('cx', x);
      c.setAttribute('cy', y);
      c.setAttribute('r', 8);
      c.setAttribute('fill', 'white');
      svg.appendChild(c);
    });
  }

  // ãƒ—ãƒ¬ã‚¤å‡¦ç†
  function playDice() {
    if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    let userData = data[currentUser];
    let bet = parseInt(document.getElementById('bet').value);
    const multiplier = parseFloat(document.getElementById('multiplier').value);
    const winrate = parseFloat(document.getElementById('winrate').value);

    if (isNaN(bet) || bet < 1) return alert("è³­ã‘é‡‘ã¯1å††ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (bet > userData.balance) return alert("æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“");
    if (multiplier < 1 || multiplier > 100) return alert("å€ç‡ã¯1ä»¥ä¸Š100ä»¥ä¸‹ã§è¨­å®šã—ã¦ãã ã•ã„");
    if (winrate <= 0 || winrate >= 100) return alert("å‹ç‡ã¯0ã‚ˆã‚Šå¤§ãã100æœªæº€ã§è¨­å®šã—ã¦ãã ã•ã„");

    userData.balance -= bet;

    // å‹æ•—åˆ¤å®š
    const roll = Math.random() * 100;
    const win = roll < winrate;

    // çµæœè¡¨ç¤ºç”¨
    let diceNumber = Math.floor(Math.random()*6) + 1; // ãƒ€ã‚¤ã‚¹ã®ç›®ï¼ˆ1-6ï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º

    drawDice(diceNumber);

    if (win) {
      const gain = Math.floor(bet * multiplier);
      userData.balance += gain;
      alert(`å‹ã¡ã¾ã—ãŸï¼ æ›ã‘é‡‘: ${bet}å††, é…å½“: ${gain}å††`);
      userData.history.push({time: Date.now(), bet: bet, result: 'å‹ã¡', balance: userData.balance});
    } else {
      alert(`è² ã‘ã¾ã—ãŸ... æ›ã‘é‡‘: ${bet}å††`);
      userData.history.push({time: Date.now(), bet: bet, result: 'è² ã‘', balance: userData.balance});
    }

    saveUserData();
    updateDisplay();
  }

  // WORKãƒœã‚¿ãƒ³å‡¦ç†
  function work() {
    if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    const userData = data[currentUser];
    const now = Date.now();
    const elapsed = now - userData.lastWork;
    const oneHour = 60 * 60 * 1000;

    if (elapsed < oneHour) {
      const leftMin = Math.ceil((oneHour - elapsed) / 60000);
      alert(`WORKã¯ã‚ã¨${leftMin}åˆ†ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚`);
      return;
    }

    workBtn.disabled = true;
    cooldownInfo.textContent = "ä½œæ¥­ä¸­...";

    // 2ã€œ10ç§’ãƒ©ãƒ³ãƒ€ãƒ å¾…ã¡
    const wait = Math.floor(Math.random() * (10000 - 2000 + 1)) + 2000;

    setTimeout(() => {
      const earn = Math.floor(Math.random() * (5000 - 200 + 1)) + 200;
      userData.balance += earn;
      userData.lastWork = Date.now();
      alert(`ä½œæ¥­å®Œäº†ï¼ +${earn}å††`);
      saveUserData();
      updateDisplay();
      workBtn.disabled = false;
      cooldownInfo.textContent = "";
    }, wait);
  }

  // éŠ€è¡Œé ã‘å…¥ã‚Œ
  function deposit() {
    if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    let amount = parseInt(document.getElementById('amount').value);
    if (isNaN(amount) || amount <= 0) return alert("æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const userData = data[currentUser];
    if (amount > userData.balance) return alert("æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“");

    userData.balance -= amount;
    userData.bank += amount;
    saveUserData();
    updateDisplay();
  }

  // éŠ€è¡Œå¼•ãå‡ºã—
  function withdraw() {
    if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    let amount = parseInt(document.getElementById('amount').value);
    if (isNaN(amount) || amount <= 0) return alert("æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const userData = data[currentUser];
    if (amount > userData.bank) return alert("éŠ€è¡Œæ®‹é«˜ãŒè¶³ã‚Šã¾ã›ã‚“");

    userData.bank -= amount;
    userData.balance += amount;
    saveUserData();
    updateDisplay();
  }

  // WORKãƒœã‚¿ãƒ³ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºæ›´æ–°
  function updateCooldownInfo() {
    if (!currentUser) return;
    const userData = data[currentUser];
    const now = Date.now();
    const oneHour = 60 * 60 * 1000;
    const elapsed = now - userData.lastWork;

    if (elapsed >= oneHour) {
      cooldownInfo.textContent = "WORKãŒåˆ©ç”¨å¯èƒ½ã§ã™";
      workBtn.disabled = false;
    } else {
      const leftSec = Math.ceil((oneHour - elapsed) / 1000);
      cooldownInfo.textContent = `WORKã¾ã§ã‚ã¨ ${leftSec}ç§’`;
      workBtn.disabled = true;

      // 1ç§’ã”ã¨ã«æ›´æ–°
      setTimeout(updateCooldownInfo, 1000);
    }
  }

</script>

</body>
</html>
